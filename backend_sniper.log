#!/data/data/com.termux/files/usr/bin/bash
# run_bot_sniper.sh - start Silvercoin backend in sniper mode

# ----------------------------
# Config
# ----------------------------
PORT=8080
LOGFILE="$HOME/silvercoin-backend/backend_sniper.log"
TWELVEDATA_API_KEY="c13f966de04f4939b4325bb55cf7ffc0"
TELEGRAM_TOKEN="8237319754:AAFAi-E0IAHuClg7l_PNfWwkMUH4QEiF7W0"
TELEGRAM_CHAT_ID="7779937295"

# ----------------------------
# Kill any previous backend processes
# ----------------------------
echo "[launcher] Stopping existing backend processes..."
PIDS=$(ps aux | grep '[b]ackend.py\|[g]unicorn backend:app' | awk '{print $2}')
if [ -n "$PIDS" ]; then
    echo "Killing: $PIDS"
    kill -9 $PIDS
fi

# ----------------------------
# Export environment variables
# ----------------------------
export PORT
export TWELVEDATA_API_KEY
export TELEGRAM_TOKEN
export TELEGRAM_CHAT_ID

# ----------------------------
# Launch backend
# ----------------------------
echo "[launcher] Starting backend (PORT=$PORT) - logging to $LOGFILE"
cd "$HOME/silvercoin-backend" || exit 1

# Run with Gunicorn (aiohttp worker)
# Note: --reload optional, remove in production
exec gunicorn backend:app \
    -b 0.0.0.0:$PORT \
    -k aiohttp.GunicornWebWorker \
    --timeout 120 \
    --log-file "$LOGFILE" \
    --access-logfile "$LOGFILE"
